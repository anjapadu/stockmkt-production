!function(e){var t={};function r(n){if(t[n])return t[n].exports;var u=t[n]={i:n,l:!1,exports:{}};return e[n].call(u.exports,u,u.exports,r),u.l=!0,u.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var u in e)r.d(n,u,function(t){return e[t]}.bind(null,u));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}({"./index.js":function(e,t,r){"use strict";r.r(t);var n=r("express"),u=r.n(n),s=r("cors"),o=r.n(s),a=r("body-parser"),i=r.n(a),c=r("morgan"),p=r.n(c),l=r("http"),d=r.n(l),f="/graph",h={ide:!1,pretty:!0},m=r("graphql"),y=r("moment"),g=r.n(y),v=function(e){return{type:m.GraphQLString,description:"Allows to receive a determinated date from database and a format it.",args:{format:{type:m.GraphQLString,description:"Moment sintaxis like DD/MM/YYYY. If not provided will return the date as unix time."}},resolve:function(t,r){if(!t[e])return"";var n=parseInt(t[e]),u=null;return u=n>0?new Date(n).getTime():t[e].getTime()/1e3,r.format?g.a.unix(u).format(r.format):u}}},w=r("sequelize"),_=r.n(w);r("dotenv").config();var b={username:process.env.DB_USER,password:process.env.DB_PASS,database:process.env.DB_NAME,host:process.env.DB_HOST,port:process.env.DB_PORT,dialect:"postgres"};console.log({databaseConfig:b});var k=b,x=new w.Sequelize({username:k.username,port:k.port,password:k.password,database:k.database,host:k.host,dialect:k.dialect});console.info("SETUP -- CONNECTTION TO DATABASE..."),x.authenticate().then((function(){console.info("=====DATABASE CONNECTED======")})).catch((function(e){console.error("======UNABLE TO CONNECT TO DATABASE=======",e)}));var O=x,S=r("uuid/v4"),L=r.n(S),R={users:O.import("users",(function(e,t){var r=e.define("users",{uuid:{type:t.UUID,primaryKey:!0,field:"uuid"},username:{type:t.STRING},password:{type:t.STRING},admin:{type:t.BOOLEAN},balance:{type:t.DECIMAL}},{tableName:"users",timestamps:!1});return r.beforeCreate((function(e,t){return e.uuid=L()()})),r.associate=function(e){},r})),stocks:O.import("stocks",(function(e,t){var r=e.define("stocks",{uuid:{type:t.UUID,primaryKey:!0,field:"uuid",defaultValue:L()()},name:{type:t.STRING},description:{type:t.STRING},companyname:{type:t.STRING},quantity:{type:t.INTEGER},currency:{type:t.STRING},companylogo:{type:t.STRING}},{tableName:"stocks",timestamps:!1});return r.associate=function(e){e.stocks.hasMany(e.stock_price,{foreignKey:"uuid"}),e.stocks.hasMany(e.future_values,{foreignKey:"uuid"})},r.beforeCreate((function(e,t){return e.uuid=L()()})),r})),stock_price:O.import("stock_price",(function(e,t){var r=e.define("stock_price",{uuid:{type:t.UUID,primaryKey:!0,field:"uuid"},stock_uuid:{type:t.UUID},close_price:{type:t.DECIMAL},timestamp:{type:t.STRING},change_price:{type:t.DECIMAL},change_percent:{type:t.DECIMAL}},{tableName:"stock_price",timestamps:!1});return r.associate=function(e){e.stock_price.belongsTo(e.stocks,{foreignKey:"stock_uuid"})},r.beforeCreate((function(e,t){return e.uuid=L()()})),r})),holdings:O.import("holdings",(function(e,t){var r=e.define("holdings",{stock_uuid:{type:t.UUID,primaryKey:!0},user_uuid:{type:t.UUID,primaryKey:!0},quantity:{type:t.INTEGER}},{tableName:"holdings",timestamps:!1});return r.associate=function(e){e.holdings.belongsTo(e.users,{foreignKey:"user_uuid"}),e.holdings.belongsTo(e.stocks,{foreignKey:"stock_uuid"})},r})),transactions:O.import("transactions",(function(e,t){var r=e.define("transactions",{uuid:{type:t.UUID,primaryKey:!0,field:"uuid"},status:{type:t.STRING},stock_uuid:{type:t.UUID},stock_price_uuid:{type:t.UUID},user_uuid:{type:t.UUID},created_at:{type:t.STRING},updated_at:{type:t.STRING},is_sell:{type:t.BOOLEAN},is_buy:{type:t.BOOLEAN},comission:{type:t.DECIMAL},quantity:{type:t.INTEGER},comission_rate:{type:t.DECIMAL},total:{type:t.DECIMAL}},{tableName:"transactions",timestamps:!1});return r.associate=function(e){e.transactions.belongsTo(e.stocks,{foreignKey:"stock_uuid"}),e.transactions.belongsTo(e.stock_price,{foreignKey:"stock_price_uuid"}),e.transactions.belongsTo(e.users,{foreignKey:"user_uuid"})},r.beforeCreate((function(e,t){return e.uuid=L()()})),r})),params:O.import("params",(function(e,t){var r=e.define("params",{uuid:{type:t.UUID,primaryKey:!0,field:"uuid"},name:{type:t.STRING},type:{type:t.STRING},value:{type:t.STRING}},{tableName:"params",timestamps:!1});return r.associate=function(e){},r.beforeCreate((function(e,t){return e.uuid=uuid()})),r})),future_values:O.import("future_values",(function(e,t){var r=e.define("future_values",{uuid:{type:t.UUID,primaryKey:!0,field:"uuid"},stock_uuid:{type:t.UUID},timestamp:{type:t.STRING},new_price:{type:t.DECIMAL},has_new:{type:t.BOOLEAN},new_text:{type:t.STRING},delay:{type:t.INTEGER},sent:{type:t.BOOLEAN}},{tableName:"future_values",timestamps:!1});return r.associate=function(e){e.future_values.belongsTo(e.stocks,{foreignKey:"stock_uuid"})},r.beforeCreate((function(e,t){return e.uuid=uuid()})),r}))};Object.keys(R).forEach((function(e){"associate"in R[e]&&R[e].associate(R)})),R.sequelize=O,_.a.postgres.DECIMAL.parse=function(e){return parseFloat(e)},R.Sequelize=_.a;var G=R;function E(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}function T(e){return function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){E(s,n,u,o,a,"next",e)}function a(e){E(s,n,u,o,a,"throw",e)}o(void 0)}))}}function N(){return Q.apply(this,arguments)}function Q(){return(Q=T(regeneratorRuntime.mark((function e(){var t,r,n,u,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.uuid,n=s.length>1&&void 0!==s[1]?s[1]:{},u=n.stock_uuid,s.length>2?s[2]:void 0,s.length>3?s[3]:void 0,console.log({uuid:r},{stock_uuid:u}),e.next=7,G.stock_price.findAll({where:{stock_uuid:r||u}});case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function I(){return D.apply(this,arguments)}function D(){return(D=T(regeneratorRuntime.mark((function e(){var t,r,n,u,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.stock_price_uuid,n=s.length>1?s[1]:void 0,u=n.uuid,e.next=4,G.stock_price.findOne({where:{uuid:r||u}});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function U(){return j.apply(this,arguments)}function j(){return(j=T(regeneratorRuntime.mark((function e(){var t,r,n,u=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:{},r=t.uuid,n=u.length>1?u[1]:void 0,n.stock_uuid,u.length>2?u[2]:void 0,u.length>3?u[3]:void 0,e.next=6,G.stock_price.findOne({where:{stock_uuid:r},order:[["timestamp","DESC"]]});case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var q=new m.GraphQLObjectType({name:"stock_price",description:"stock_price",fields:function(){return{uuid:{type:m.GraphQLString,description:"UUID of the stock"},stock_uuid:{type:m.GraphQLString,description:"Stock UUID reference"},close_price:{type:m.GraphQLFloat,description:"Description of the stock"},timestamp:v("timestamp"),change_price:{type:m.GraphQLFloat,description:"Total actions existing"},change_percent:{type:m.GraphQLFloat,description:"Currency of stock - PEN / USD"}}}}),A=new m.GraphQLObjectType({name:"stocks",description:"stocks",fields:function(){return{uuid:{type:m.GraphQLString,description:"UUID of the stock"},name:{type:m.GraphQLString,description:"Stock name - Company"},description:{type:m.GraphQLString,description:"Description of the stock"},companylogo:{type:m.GraphQLString},companyname:{type:m.GraphQLString,description:"Company that own the stock"},quantity:{type:m.GraphQLInt,description:"Total actions existing"},currency:{type:m.GraphQLString,description:"Currency of stock - PEN / USD"},last_price:{type:q,resolve:U},stock_price_history:{type:Object(m.GraphQLList)(q),resolve:N}}}});r("url-metadata");var P=r("cryptr"),C=new(r.n(P).a)("SECRET");function F(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function M(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}function z(e){return function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){M(s,n,u,o,a,"next",e)}function a(e){M(s,n,u,o,a,"throw",e)}o(void 0)}))}}function B(){return(B=z(regeneratorRuntime.mark((function e(t,r,n,u){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.users.findAll({});case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),console.log(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))).apply(this,arguments)}function K(){return H.apply(this,arguments)}function H(){return(H=z(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{comission:global.comission,exchangeRate:global.exchangeRate,status:global.status});case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Y(){return W.apply(this,arguments)}function W(){return(W=z(regeneratorRuntime.mark((function e(){var t,r,n,u,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.user_uuid,n=s.length>1?s[1]:void 0,u=n.uuid,s.length>2?s[2]:void 0,s.length>3?s[3]:void 0,e.prev=4,""!==u){e.next=8;break}return console.log("LLEGO VACIO"),e.abrupt("return",{uuid:null,username:null,admin:!1,balance:null});case 8:return e.next=10,G.users.findOne({where:{uuid:r||u}});case 10:return e.abrupt("return",e.sent);case 13:return e.prev=13,e.t0=e.catch(4),console.log(e.t0),e.abrupt("return",{uuid:null,username:null,admin:!1,balance:null});case 17:case"end":return e.stop()}}),e,null,[[4,13]])})))).apply(this,arguments)}function V(){return(V=z(regeneratorRuntime.mark((function e(t,r,n,u){var s,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.username,o=r.password,e.next=3,G.users.findOne({where:{username:F({},G.Sequelize.Op.iLike,s)},raw:!0});case 3:if(a=e.sent){e.next=6;break}throw new Error("NOT_FOUND");case 6:if(a.password===o){e.next=8;break}throw new Error("WRONG_PASS");case 8:return e.abrupt("return",a);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function X(){return(X=z(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.uuid,e.next=3,G.transactions.destroy({where:{user_uuid:n}});case 3:return e.next=5,G.holdings.destroy({where:{user_uuid:n}});case 5:return e.next=7,G.users.destroy({where:{uuid:n}});case 7:return e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function J(){return(J=z(regeneratorRuntime.mark((function e(t,r,n,u){var s,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.username,o=r.password,e.next=3,G.users.count({where:{username:F({},G.Sequelize.Op.iLike,s)},raw:!0});case 3:if(!(e.sent>0)){e.next=6;break}throw new Error("USER_EXISTS");case 6:return e.prev=6,e.next=9,G.users.create({username:s,password:o},{isNewRecord:!0,raw:!0});case 9:return a=e.sent,e.abrupt("return",a.get({plain:!0}));case 13:e.prev=13,e.t0=e.catch(6),console.log("Error createUser",e.t0);case 16:case"end":return e.stop()}}),e,null,[[6,13]])})))).apply(this,arguments)}function Z(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}function $(e){return function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){Z(s,n,u,o,a,"next",e)}function a(e){Z(s,n,u,o,a,"throw",e)}o(void 0)}))}}function ee(){return(ee=$(regeneratorRuntime.mark((function e(t,r,n,u){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.stocks.findAll({});case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),console.log(e.t0);case 9:case"end":return e.stop()}}),e,null,[[0,6]])})))).apply(this,arguments)}function te(e,t,r,n){return re.apply(this,arguments)}function re(){return(re=$(regeneratorRuntime.mark((function e(t,r,n,u){var s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.stock_uuid,e.prev=1,e.next=4,G.stocks.findOne({where:{uuid:s}});case 4:return e.abrupt("return",e.sent);case 7:e.prev=7,e.t0=e.catch(1),console.log(e.t0);case 10:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}var ne=new m.GraphQLObjectType({name:"holdings",description:"holdings",fields:function(){return{stock_uuid:{type:m.GraphQLString},user_uuid:{type:m.GraphQLString},quantity:{type:m.GraphQLInt},user:{type:ie,resolve:Y},stock:{type:A,resolve:te}}}}),ue=new m.GraphQLObjectType({name:"params",description:"params",fields:function(){return{comission:{type:m.GraphQLFloat},exchangeRate:{type:m.GraphQLFloat},status:{type:m.GraphQLString}}}});function se(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}function oe(){return ae.apply(this,arguments)}function ae(){var e;return e=regeneratorRuntime.mark((function e(){var t,r,n,u,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s.length>0&&void 0!==s[0]?s[0]:{},r=t.uuid,n=s.length>1?s[1]:void 0,u=n.user_uuid,s.length>2&&s[2],s.length>3&&s[3],e.prev=4,e.next=7,G.holdings.findAll({where:{user_uuid:r||u}});case 7:return e.abrupt("return",e.sent);case 10:e.prev=10,e.t0=e.catch(4),console.log(e.t0);case 13:case"end":return e.stop()}}),e,null,[[4,10]])})),(ae=function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){se(s,n,u,o,a,"next",e)}function a(e){se(s,n,u,o,a,"throw",e)}o(void 0)}))}).apply(this,arguments)}var ie=new m.GraphQLObjectType({name:"users",description:"users",fields:function(){return{uuid:{type:m.GraphQLString,description:"UUID of the user"},username:{type:m.GraphQLString,description:"Username of the user"},admin:{type:m.GraphQLBoolean,description:"User flag admin"},balance:{type:m.GraphQLFloat,resolve:function(e){return e.balance}},holdings:{type:Object(m.GraphQLList)(ne),resolve:oe},params:{type:ue,resolve:K}}}}),ce=r("graphql-type-json"),pe=r.n(ce),le=(new m.GraphQLObjectType({name:"updateResponse",description:"Basic response type for updates where we just need to know that happened successfuly",fields:function(){return{updated:{type:m.GraphQLBoolean,description:"If updated successfuly or not"},message:{type:m.GraphQLString,description:"Custom message to show"}}}}),new m.GraphQLObjectType({name:"successType",description:"Basic response type where just we need to know that the query or proceess finished successfuly",fields:function(){return{success:{type:m.GraphQLBoolean,description:"If succeded or not"},message:{type:m.GraphQLString,description:"Custom message to show"},response:{type:pe.a}}}})),de={},fe={};de.login={type:ie,description:"To login to the dashboard",args:{username:{type:Object(m.GraphQLNonNull)(m.GraphQLString),description:"User name. In this case is an email."},password:{type:Object(m.GraphQLNonNull)(m.GraphQLString),description:"Password of the account. Min 8 length"}},resolve:function(e,t,r,n){return V.apply(this,arguments)}},de.user={type:ie,description:"",args:{uuid:{type:m.GraphQLString}},resolve:Y},de.users={type:Object(m.GraphQLList)(ie),description:"",resolve:function(e,t,r,n){return B.apply(this,arguments)}},fe.createUser={type:ie,description:"Allows to create a new user",args:{username:{type:Object(m.GraphQLNonNull)(m.GraphQLString),description:"Email of the user"},password:{type:Object(m.GraphQLNonNull)(m.GraphQLString)}},resolve:function(e,t,r,n){return J.apply(this,arguments)}},fe.deleteUser={type:le,args:{uuid:{type:m.GraphQLString}},resolve:function(e,t){return X.apply(this,arguments)}};var he={};he.stocks={type:Object(m.GraphQLList)(A),description:"Stock",resolve:function(e,t,r,n){return ee.apply(this,arguments)}};var me={};me.stock_price={type:Object(m.GraphQLList)(q),description:"StockPrice",args:{stock_uuid:{type:Object(m.GraphQLNonNull)(m.GraphQLString)}},resolve:N};var ye={};ye.holdings={type:Object(m.GraphQLList)(ne),args:{user_uuid:{type:Object(m.GraphQLNonNull)(m.GraphQLString)}},description:"Holdings",resolve:oe};var ge=new m.GraphQLObjectType({name:"transactions",description:"transactions",fields:function(){return{uuid:{type:m.GraphQLString,description:"UUID of the user"},status:{type:m.GraphQLString,description:"Username of the user"},stock_uuid:{type:m.GraphQLString,description:"User flag admin"},stock_price_uuid:{type:m.GraphQLString},user_uuid:{type:m.GraphQLString},created_at:v("created_at"),updated_at:v("created_at"),is_buy:{type:m.GraphQLBoolean},is_sell:{type:m.GraphQLBoolean},stock_price:{type:q,resolve:I},stock:{type:A,resolve:te},comission:{type:m.GraphQLFloat},quantity:{type:m.GraphQLInt},comission_rate:{type:m.GraphQLFloat},total:{type:m.GraphQLFloat}}}}),ve=r("socket.io"),we=r.n(ve),_e=u()(),be=Object(l.Server)(_e),ke=we()(be,{origins:"*:*"});function xe(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}function Oe(e){return function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){xe(s,n,u,o,a,"next",e)}function a(e){xe(s,n,u,o,a,"throw",e)}o(void 0)}))}}function Se(){return(Se=Oe(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user_uuid,e.next=3,G.transactions.findAll({where:{user_uuid:n},order:[["updated_at","DESC"]]});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Le(e,t,r,n,u,s,o){return Re.apply(this,arguments)}function Re(){return(Re=Oe(regeneratorRuntime.mark((function e(t,r,n,u,s,o,a){var i,c,p,l,d;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,G.users.findOne({where:{uuid:t},raw:!0});case 2:if(i=e.sent,c="USD"===a?r:r/global.exchangeRate,p=i.balance,!u){e.next=15;break}if(!(p>=c)){e.next=12;break}if(!(c>=1500)){e.next=9;break}return e.abrupt("return",p);case 9:throw new Error("NOT_VALID_BUY");case 12:throw new Error("NOT_ENOUGHT_FUNDS");case 13:e.next=28;break;case 15:return e.next=17,G.holdings.findOne({where:{user_uuid:t,stock_uuid:s}});case 17:if(l=e.sent.quantity,d="USD"===a?l*o:l*o/global.exchangeRate,!(c>=1500&&l>=n)){e.next=23;break}return e.abrupt("return",p);case 23:if(!(c<1500&&d<1500)){e.next=27;break}return e.abrupt("return",p);case 27:throw new Error("NOT_VALID_SELL");case 28:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ge(e,t,r,n){return Ee.apply(this,arguments)}function Ee(){return(Ee=Oe(regeneratorRuntime.mark((function e(t,r,n,u){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:G.users.update({balance:parseFloat((n+(t?-1*r:r)).toFixed(2))},{where:{uuid:u}}),ke.sockets.adapter.rooms["user-".concat(u)]&&ke.to("user-".concat(u)).emit("new.balance",parseFloat((n+(t?-1*r:r)).toFixed(2)));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Te(e,t,r,n){return Ne.apply(this,arguments)}function Ne(){return(Ne=Oe(regeneratorRuntime.mark((function e(t,r,n,u){var s,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,G.holdings.findOne({where:{user_uuid:r,stock_uuid:t},raw:!0});case 2:if(s=e.sent){e.next=9;break}return e.next=6,G.holdings.create({stock_uuid:t,user_uuid:r,quantity:n}).then((function(e){return e.get({plan:!0})}));case 6:ke.sockets.adapter.rooms["user-".concat(r)]&&ke.to("user-".concat(r)).emit("upsert.holding",{stock_uuid:t,quantity:n}),e.next=16;break;case 9:return o=s.quantity+(u?n:-n),e.next=12,G.holdings.update({quantity:o},{where:{stock_uuid:t,user_uuid:r},raw:!0});case 12:if(0!=o){e.next=15;break}return e.next=15,G.holdings.destroy({where:{stock_uuid:t,user_uuid:r}});case 15:ke.sockets.adapter.rooms["user-".concat(r)]&&ke.to("user-".concat(r)).emit("upsert.holding",{stock_uuid:t,quantity:s.quantity+(u?n:-n)});case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Qe(){return(Qe=Oe(regeneratorRuntime.mark((function e(t,r){var n,u,s,o,a,i,c,p,l,d,f,h,m;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.user_uuid,u=r.stock_uuid,s=r.stock_price_uuid,o=r.is_buy,a=r.quantity,e.next=3,G.stock_price.findOne({where:{stock_uuid:u},order:[["timestamp","DESC"]],raw:!0,include:[{model:G.stocks}]});case 3:if(i=e.sent,c=i["stock.currency"],p=i.uuid,l=i.close_price,d=a*l,p!==s){e.next=20;break}return f=parseFloat(o?(global.comission*d+d).toFixed(2):(d-global.comission*d).toFixed(2)),e.next=12,Le(n,f,a,o,u,l,c);case 12:return h=e.sent,"PEN"===c&&(f/=global.exchangeRate),e.next=16,G.transactions.create({stock_uuid:u,status:"COMPLETED",stock_price_uuid:s,user_uuid:n,is_buy:o,is_sell:!o,comission:(global.comission*d).toFixed(2),comission_rate:global.comission,total:f,quantity:a}).then((function(e){return e.get({plain:!0})}));case 16:return m=e.sent,Ge(o,f,h,n),Te(u,n,a,o),e.abrupt("return",m);case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}be.listen(process.env.SOCKET_PORT,(function(){console.log("SOCKEET WORKING ON 5020")}));var Ie={},De={};function Ue(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}function je(e){return function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){Ue(s,n,u,o,a,"next",e)}function a(e){Ue(s,n,u,o,a,"throw",e)}o(void 0)}))}}Ie.transactions={type:Object(m.GraphQLList)(ge),description:"To login to the dashboard",args:{user_uuid:{type:Object(m.GraphQLNonNull)(m.GraphQLString),description:"User name. In this case is an email."}},resolve:function(e,t){return Se.apply(this,arguments)}},De.buyOrSell={type:ge,description:"Allows to create a transaction to buy or sell actions",args:{user_uuid:{type:m.GraphQLString},stock_uuid:{type:m.GraphQLString},stock_price_uuid:{type:m.GraphQLString},is_buy:{type:m.GraphQLBoolean},quantity:{type:m.GraphQLInt}},resolve:function(e,t){return Qe.apply(this,arguments)}};var qe=function(){var e=je(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.comission,e.next=3,G.params.update({value:n},{where:{name:"comission"}});case 3:return ke.emit("param.change",{name:"comission",value:n}),global.comission=n,e.abrupt("return",{success:!0});case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),Ae=function(){var e=je(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.exchangeRate,e.next=3,G.params.update({value:n},{where:{name:"exchange_rate"}});case 3:return ke.emit("param.change",{name:"exchangeRate",value:n}),global.exchangeRate=n,e.abrupt("return",{success:!0});case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),Pe=function(){var e=je(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.status,e.next=3,G.params.update({value:n},{where:{name:"status"}});case 3:return ke.emit("param.change",{name:"status",value:n}),global.status=n,e.abrupt("return",{success:!0});case 6:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),Ce={},Fe=new m.GraphQLObjectType({name:"successResponse",description:"successResponse",fields:function(){return{success:{type:m.GraphQLBoolean}}}});Ce.changeComission={type:Fe,args:{comission:{type:m.GraphQLFloat}},resolve:qe},Ce.changeExchangeRate={type:Fe,args:{exchangeRate:{type:m.GraphQLFloat}},resolve:Ae},Ce.changeStatus={type:Fe,args:{status:{type:m.GraphQLString}},resolve:Pe};var Me=new m.GraphQLObjectType({name:"OldNews",description:"OldNews",fields:function(){return{new:{type:m.GraphQLString},stockUUID:{type:m.GraphQLString}}}});function ze(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}var Be={},Ke=function(){var e,t=(e=regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,G.future_values.findAll({where:{sent:!0,has_new:!0},raw:!0,order:[["timestamp","DESC"]]});case 2:return t=e.sent,e.abrupt("return",t.map((function(e){return{stockUUID:e.stock_uuid,new:e.new_text}})));case 4:case"end":return e.stop()}}),e)})),function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){ze(s,n,u,o,a,"next",e)}function a(e){ze(s,n,u,o,a,"throw",e)}o(void 0)}))});return function(){return t.apply(this,arguments)}}();function He(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Ye(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?He(r,!0).forEach((function(t){We(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):He(r).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function We(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Be.oldNews={type:Object(m.GraphQLList)(Me),resolve:Ke};var Ve=new m.GraphQLObjectType({name:"query",description:"All the methods to read data ",fields:function(){return Ye({},de,{},he,{},me,{},ye,{},Ie,{},Be)}}),Xe=new m.GraphQLObjectType({name:"mutations",description:"All the methods to create, modify of create data",fields:function(){return Ye({},De,{},Ce,{},fe)}}),Je=new m.GraphQLSchema({query:Ve,mutation:Xe}),Ze=r("express"),$e=r("express-graphql"),et=h,tt=et.ide,rt=et.pretty,nt=f,ut=Ze.Router();console.info("GRAPHQL STARTING..."),ut.use(nt,(function(e,t){$e({schema:Je,graphiql:tt,pretty:rt,customFormatErrorFn:function(e){return e.message}})(e,t)}));var st=ut,ot=r("./src/lib/security-middleware/UnauthorizedError.js"),at=r.n(ot),it=r("async"),ct=r.n(it),pt=r("express-unless"),lt=r.n(pt),dt=function(e,t,r){return r(null,!1)};r("path");function ft(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function ht(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ft(r,!0).forEach((function(t){mt(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ft(r).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function mt(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function yt(e,t,r,n,u,s,o){try{var a=e[s](o),i=a.value}catch(e){return void r(e)}a.done?t(i):Promise.resolve(i).then(n,u)}function gt(e){return function(){var t=this,r=arguments;return new Promise((function(n,u){var s=e.apply(t,r);function o(e){yt(s,n,u,o,a,"next",e)}function a(e){yt(s,n,u,o,a,"throw",e)}o(void 0)}))}}r("connect-gzip-static"),r("fs");var vt,wt,_t=r("node-cron");global.comission=null,global.status=null,global.exchangeRate=null,global.ids=null,(vt=gt(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,G.params.findAll({raw:!0});case 2:e.sent.forEach((function(e){switch(e.name){case"comission":global.comission=parseFloat(e.value);break;case"exchange_rate":global.exchangeRate=parseFloat(e.value);break;default:global.status=e.value}}));case 4:case"end":return e.stop()}}),e)}))),function(){return vt.apply(this,arguments)})(),(wt=gt(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,G.stocks.findAll({raw:!0});case 2:t=e.sent,r=t.reduce((function(e,t){return e[t.uuid]=!0,e}),{}),global.ids=r;case 5:case"end":return e.stop()}}),e)}))),function(){return wt.apply(this,arguments)})();var bt=u()(),kt=function(e){var t,r=e.secret;t=r,"[object Function]"!==Object.prototype.toString.call(t)&&(r=function(e){return function(t,r,n){return n(null,e)}}(r));var n=e.isRevoked||dt,u=e.userProperty||e.requestProperty||"user",s=e.resultProperty,o=void 0===e.credentialsRequired||e.credentialsRequired,a=function(t,r,a){var i;if("OPTIONS"===t.method&&t.headers.hasOwnProperty("access-control-request-headers")&&!!~t.headers["access-control-request-headers"].split(",").map((function(e){return e.trim()})).indexOf("authorization"))return a();if(e.getToken&&"function"==typeof e.getToken)try{i=e.getToken(t)}catch(e){return a(e)}else if(t.headers&&t.headers.authorization){var c=t.headers.authorization.split(" ");if(2!=c.length)return a(new at.a("credentials_bad_format",{message:"Format is Authorization: Bearer [token]"}));var p=c[0],l=c[1];if(!/^Bearer$/i.test(p))return o?a(new at.a("credentials_bad_scheme",{message:"Format is Authorization: Bearer [token]"})):a();i=l}if(!i)return o?a(new at.a("credentials_required",{message:"No authorization token was found"})):a();ct.a.waterfall([function(e){var t;try{t=function(e){var t;try{t=C.decrypt(e)}catch(e){throw new Error("invalid_token")}return t}(i),t=JSON.parse(t),console.log("=======",{decoded:t}),e(null,t)}catch(t){e(new at.a("invalid_token",t))}},function(e,r){n(t,e,(function(t,n){t?r(t):n?r(new at.a("revoked_token",{message:"The token has been revoked."})):r(null,e)}))}],(function(e,n){if(e)return a(e);s?r[s]=n:t[u]=n,a()}))};return a.unless=lt.a,a.UnauthorizedError=at.a,a}({credentialsRequired:!1});bt.use("/graph",kt),bt.disable("x-powered-by"),bt.use(i.a.urlencoded({extended:!0})),bt.use(i.a.json()),bt.use(p()(":method :url :status :res[content-length] - :response-time ms"));var xt={origin:function(e,t){return t(null,!0)}};function Ot(){return St.apply(this,arguments)}function St(){return(St=gt(regeneratorRuntime.mark((function e(){var t,r,n,u,s,o,a,i,c,p,l,d=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=d.length>0&&void 0!==d[0]&&d[0],e.next=3,G.future_values.findAll({where:{sent:!1,timestamp:G.Sequelize.literal("future_values.timestamp = (SELECT MIN(timestamp) FROM future_values as fv WHERE fv.stock_uuid = future_values.stock_uuid AND fv.sent is not true)")},order:[["timestamp","ASC"]],raw:!0});case 3:if((r=e.sent)&&0!==r.length){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,G.stock_price.findAll({where:{timestamp:G.Sequelize.literal("timestamp = (SELECT MAX(timestamp) FROM stock_price as sp WHERE sp.stock_uuid = stock_price.stock_uuid)")},raw:!0});case 8:return e.t0=function(e,t){return e[t.stock_uuid]=t,e},e.t1={},n=e.sent.reduce(e.t0,e.t1),u=r.map((function(e){var t=n[e.stock_uuid].close_price,r=100-t/e.new_price*100,u=e.new_price-t;return{uuid:L()(),hasNew:e.has_new,newText:e.new_text,stock_uuid:e.stock_uuid,close_price:e.new_price.toFixed(2),timestamp:g()().format("YYYY-MM-DD HH:mm:ss"),change_price:u.toFixed(2),change_percent:r.toFixed(2)}})),s=u.filter((function(e){return e.hasNew})),o=s.map((function(e){return{stockUUID:e.stock_uuid,new:e.newText}})),ke.emit("new.new",{news:o,time:g()().format("DD/MM/YYYY_HH:mm:ss")}),setTimeout(gt(regeneratorRuntime.mark((function e(){var t,r,n,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,G.stock_price.bulkCreate(s,{returning:!0});case 2:return t=e.sent,r=t.reduce((function(e,t){return e[t.stock_uuid]=t.uuid,e}),{}),n=s.map((function(e){return e.stock_uuid})),e.next=7,G.future_values.update({sent:!0},{where:{timestamp:G.Sequelize.literal("future_values.timestamp = (SELECT MIN(timestamp) FROM future_values as fv WHERE fv.stock_uuid = future_values.stock_uuid AND sent IS NOT true)"),stock_uuid:mt({},G.Sequelize.Op.in,n)}});case 7:u=s.reduce((function(e,t){return e[t.stock_uuid]=ht({},t,{priceUUID:r[t.stock_uuid]}),e}),{}),ke.emit("new.stock.values",{values:u});case 9:case"end":return e.stop()}}),e)}))),t?500:12e4),a=u.filter((function(e){return!e.hasNew})),e.next=19,G.stock_price.bulkCreate(a,{returning:!0});case 19:return i=e.sent,c=a.map((function(e){return e.stock_uuid})),p=i.reduce((function(e,t){return e[t.stock_uuid]=t.uuid,e}),{}),e.next=24,G.future_values.update({sent:!0},{where:{timestamp:G.Sequelize.literal("future_values.timestamp = (SELECT MIN(timestamp) FROM future_values as fv WHERE fv.stock_uuid = future_values.stock_uuid AND sent IS NOT true)"),stock_uuid:mt({},G.Sequelize.Op.in,c)}});case 24:l=a.reduce((function(e,t){return e[t.stock_uuid]=ht({},t,{priceUUID:p[t.stock_uuid]}),e}),{}),ke.emit("new.stock.values",{values:l});case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}bt.use(o()(xt)),bt.use("/",st),bt.use((function(e,t,r,n){if(e)switch(e.message){case"AUTHORIZATION_ERROR":return r.status(401).json({code:403,message:"Authorization error"});case"ERR_CORS":return r.status(403).json({code:403,message:"Not allowed by CORS"});default:return r.status(e.status||500).json({code:e.status||500,message:e.message.charAt(0).toUpperCase()+e.message.slice(1)})}return n()})),ke.use((function(e,t){var r=e.request._query.userUUID;r&&(console.log("CONECTO A USER SOCKET"),e.join("user-".concat(r))),t()})),ke.on("connection",(function(e){console.log("CONNECTED USER")})),bt.get("/shot",(function(e,t){Ot(!0),t.status(200).send({success:!0})})),d.a.createServer(bt).listen(process.env.APP_PORT,(function(){console.log("HTTP Server running on 5010"),_t.schedule("*/3 * * * *",gt(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("Sending New Value"),"STARTED"===global.status&&Ot();case 2:case"end":return e.stop()}}),e)}))))}))},"./src/lib/security-middleware/UnauthorizedError.js":function(e,t){function r(e,t){this.name="UnauthorizedError",this.message=t.message,Error.call(this,t.message),Error.captureStackTrace(this,this.constructor),this.code=e,this.status=401,this.inner=t}r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,e.exports=r},0:function(e,t,r){r("@babel/polyfill"),e.exports=r("./index.js")},"@babel/polyfill":function(e,t){e.exports=require("@babel/polyfill")},async:function(e,t){e.exports=require("async")},"body-parser":function(e,t){e.exports=require("body-parser")},"connect-gzip-static":function(e,t){e.exports=require("connect-gzip-static")},cors:function(e,t){e.exports=require("cors")},cryptr:function(e,t){e.exports=require("cryptr")},dotenv:function(e,t){e.exports=require("dotenv")},express:function(e,t){e.exports=require("express")},"express-graphql":function(e,t){e.exports=require("express-graphql")},"express-unless":function(e,t){e.exports=require("express-unless")},fs:function(e,t){e.exports=require("fs")},graphql:function(e,t){e.exports=require("graphql")},"graphql-type-json":function(e,t){e.exports=require("graphql-type-json")},http:function(e,t){e.exports=require("http")},moment:function(e,t){e.exports=require("moment")},morgan:function(e,t){e.exports=require("morgan")},"node-cron":function(e,t){e.exports=require("node-cron")},path:function(e,t){e.exports=require("path")},sequelize:function(e,t){e.exports=require("sequelize")},"socket.io":function(e,t){e.exports=require("socket.io")},"url-metadata":function(e,t){e.exports=require("url-metadata")},"uuid/v4":function(e,t){e.exports=require("uuid/v4")}});